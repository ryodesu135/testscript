local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
local Icons = loadstring(game:HttpGetAsync("https://raw.githubusercontent.com/Footagesus/Icons/main/Main.lua"))()
Icons.SetIconsType("lucide")

local Window = WindUI:CreateWindow({
    Title = "Lights Hub",
    Author = "by Ryo",
    Folder = "LightsHub",
    
    -- â†“ This all is Optional. You can remove it.
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 200,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = false,
    ToggleKey = Enum.KeyCode.K,
})

-- ðŸ§  åˆå§‹åŒ–å…¨å±€å˜é‡
getgenv().UserSetWalkSpeed = nil
getgenv().UserSetJumpPower = nil
getgenv().SpeedMonitorRunning = false

-- âœ… æ•æ‰å½“å‰è§’è‰² WalkSpeed / JumpPower
local player = game.Players.LocalPlayer

local function captureCurrentStats()
    local char = player.Character or player.CharacterAdded:Wait()
    local humanoid = char:WaitForChild("Humanoid")
    getgenv().CurrentWalkSpeed = humanoid.WalkSpeed
    getgenv().CurrentJumpPower = humanoid.JumpPower
    print("[DEBUG] æ•æ‰å½“å‰é€Ÿåº¦:", getgenv().CurrentWalkSpeed, " è·³è·ƒåŠ›:", getgenv().CurrentJumpPower)
end

-- âœ… ç»´æŒè®¾å®šçš„é€Ÿåº¦ä¸Žè·³è·ƒåŠ›
task.spawn(function()
    getgenv().SpeedMonitorRunning = true
    while getgenv().SpeedMonitorRunning do
        pcall(function()
            local char = player.Character
            local humanoid = char and char:FindFirstChild("Humanoid")
            if humanoid then
                if getgenv().UserSetWalkSpeed and humanoid.WalkSpeed ~= getgenv().UserSetWalkSpeed then
                    humanoid.WalkSpeed = getgenv().UserSetWalkSpeed
                end
                if getgenv().UserSetJumpPower and humanoid.JumpPower ~= getgenv().UserSetJumpPower then
                    humanoid.JumpPower = getgenv().UserSetJumpPower
                end
            end
        end)
        task.wait(0.3)
    end
end)

--Main Tab
local MainTab = Window:Tab({
    Title = "About",
    Icon = "lightbulb",
}) 

local PlayerTab = Window:Tab({
        Title = "Player",
        Icon = "user",
    })

-------------------------------------------------
-- çŽ©å®¶è®¾å®šï¼ˆWalkSpeedã€Jumpï¼‰
-------------------------------------------------
PlayerTab:Slider({
        Flag = "Slider1",
        Title = "Walk Speed",
        Desc = "Adjust Your Walk Speed",
        Step = 1,
        Value = {
            Min = 30,
            Max = 150,
            Default = getgenv().CurrentWalkSpeed or 35,
        },
        Callback = function(Value)
        local char = player.Character
        local humanoid = char and char:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = Value
            getgenv().UserSetWalkSpeed = Value
            print("[DEBUG] çŽ©å®¶è®¾å®š WalkSpeed:", Value)
        end
    end,
    })

PlayerTab:Slider({
    Flag = "Slider2",
    Title = "Jump Height",
    Desc = "Adjust Your Jump Height",
    Step = 1,
    Value = {
        Min = 50,
        Max = 200,
        Default = getgenv().CurrentJumpPower or 50,
    },
    Callback = function(Value)
        local char = player.Character
        local humanoid = char and char:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.JumpPower = Value
            getgenv().UserSetJumpPower = Value
            print("[DEBUG] çŽ©å®¶è®¾å®š JumpPower:", Value)
        end
    end,
})

-------------------------------------------------
-- ðŸ›¡ï¸ Anti AFK
-------------------------------------------------

local bb = game:service'VirtualUser'
local afkConnection

PlayerTab:Toggle({
    Flag = "Toggle1",
    Title = "Anti AFK",
    Desc = "Prevents you from being kicked for being AFK",
    Type = "Checkbox",
    Value = false,
    Callback = function(state)
        if state then
            game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                ["Value"] = false,
                ["Path"] = {"Settings", "AFK_MODE"},
                ["Action"] = "Settings",
            })
            afkConnection = player.Idled:Connect(function()
                bb:CaptureController()
                bb:ClickButton2(Vector2.new())
                wait(2)
            end)
        else
            if afkConnection then
                afkConnection:Disconnect()
                afkConnection = nil
            end
        end
    end,
})

-------------------------------------------------
-- ðŸ›‘ Anti Public Serverï¼ˆåŠŸèƒ½å®Œæ•´æ•´åˆï¼‰
-------------------------------------------------

getgenv().AntiPublicEnabled = false
getgenv().AntiPublicWhitelist = {}

--âœ¨ å°†è¾“å…¥æ¡†å†…å®¹ â†’ è¡¨è½¬æ¢
local function updateWhitelist(text)
    local list = {}
    for name in string.gmatch(text, "([^,%s]+)") do
        table.insert(list, name)
    end
    getgenv().AntiPublicWhitelist = list
    print("[DEBUG] Whitelist Updated:", table.concat(list, ", "))
end

--âœ¨ ä¸»åŠŸèƒ½ï¼šæ£€æµ‹æ˜¯å¦è¦ kick è‡ªå·±
local function checkServerPlayers()
    while getgenv().AntiPublicEnabled do
        task.wait(3)

        if not getgenv().AntiPublicEnabled then break end

        local Players = game:GetService("Players")
        local others = {}
        local whitelistFound = false

        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= player then
                local name = p.Name

                -- æ£€æŸ¥æ˜¯ä¸æ˜¯ whitelist äºº
                local isWhitelisted = table.find(getgenv().AntiPublicWhitelist, name) ~= nil

                if isWhitelisted then
                    whitelistFound = true
                else
                    table.insert(others, name)
                end
            end
        end

        -- ðŸŸ¢ å¦‚æžœ whitelist é‡Œé¢çš„äººåœ¨ï¼Œä½†**æ²¡æœ‰å…¶ä»–äºº** â†’ ä¸ kick
        if whitelistFound and #others == 0 then
            continue
        end

        -- âŒ æœ‰é™Œç”ŸçŽ©å®¶ï¼ˆothers > 0ï¼‰â†’ Kick
        if #others > 0 then
            local reason = "Anti Public Server: Detected Non-Whitelist Player(s): " .. table.concat(others, ", ")
            player:Kick(reason)
            break
        end
    end
end

--ðŸŸ¢ Anti Public Server Toggle
PlayerTab:Toggle({
    Flag = "Toggle2",
    Title = "Anti Public Server",
    Desc = "Automatically kicks you from public servers when non-whitelisted players are detected.",
    Value = false,
    Callback = function(state)
        getgenv().AntiPublicEnabled = state

        if state then
            print("[DEBUG] Anti Public Server Enabled")
            task.spawn(checkServerPlayers)
        else
            print("[DEBUG] Anti Public Server Disabled")
        end
    end,
})

--ðŸ“ Whitelist è¾“å…¥æ¡†
PlayerTab:Input({
    Flag = "Input1",
    Title = "Whitelist Player",
    Desc = "Enter player username (Not Display Name) separated by commas to whitelist them.",
    Value = "",
    Type = "Textarea",
    Placeholder = "User1, User2, User3",
    Callback = function(input)
        updateWhitelist(input)
    end,
})


local RankingTab = Window:Tab({
        Title = "Ranking",
        Icon = "chart-line",
    })

-- âœ… Auto Rank Up
RankingTab:Toggle({
    Flag = "RankUp1",
    Title = "Auto Rank Up",
    Desc = "Automatically rank up",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().AutoRankUpRunning = true
            task.spawn(function()
                while getgenv().AutoRankUpRunning do
                    pcall(function()
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                            ["Upgrading_Name"] = "Rank",
                            ["Action"] = "_Upgrades",
                            ["Upgrade_Name"] = "Rank_Up",
                        })
                    end)
                    task.wait(10)
                end
            end)
        else
            getgenv().AutoRankUpRunning = false
        end
    end,
})

--Auto Prestige
RankingTab:Toggle({
    Flag = "AutoPrestige1",
    Title = "Auto Prestige",
    Desc = "Automatically prestige levels",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().AutoPrestigeRunning = true
            task.spawn(function()
                while getgenv().AutoPrestigeRunning do
                    pcall(function()
                        -- âœ… è‡ªåŠ¨å‡çº§å£°æœ›
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Action"] = "Level_Up_Prestige",
                        })
                    end)

                    task.wait(5)
                end
            end)
        else
            getgenv().AutoPrestigeRunning = false
        end
    end,
})

local CodesTab = Window:Tab({
        Title = "Codes",
        Icon = "ticket",
    })

-- âœ… Redeem Codes Button
CodesTab:Button({
    Flag = "RedeemCodes1",
    Title = "Redeem All Codes",
    Desc = "Redeem all codes automatically.",
    Locked = false,
    Callback = function()
    local codes = {"SlashX", "Derp", "Heyyyo", 
    "Update24P2", "720KFav", "725KFav", "230MVisits", "Update24Part2Code",
    "Update24P3", "730KFav", "735KFav", "390KLikes", "235MVisits",
    "Update25", "740KFav", "745KFav", "240MVisits", "StoneCode",
    "Update25P2", "750KFav", "395KLikes", "245MVisits", "Labyrinth", "Update25DelayP2", "ImGreenOnUpdate25", "Update25P2Restart1",
    "Update26", "755KFav", "Update26Code", "ThanksgivingOnPart2?", "Update26Code2", "Update26Restart1",
    "Update26P2", "250MVisits", "Update26P2Code", "SorryNoTurkey", "PowerOfFriendship",
    "Update27", "400KLikes", "760KFav", "Update27Code", "NoThanksgivingCode" , "Update27Delay", "Update27Restart", "Update27HeroKey", "SorryNoTurkey2", "SorryNoTurkey3", "SorryNoTurkey4"

}
    for i, code in ipairs(codes) do
            local success, err = pcall(function()
                game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                    ["Action"] = "_Redeem_Code", 
                    ["Text"] = code,
                })
            end)
            
            if success then
                -- æ–°å¢žè°ƒè¯•ï¼šæˆåŠŸå…‘æ¢
                print("[DEBUG] Successfully fired event for code: " .. code)
            else
                -- æ–°å¢žè°ƒè¯•ï¼šå¤±è´¥æ—¶æ‰“å°é”™è¯¯
                print("[DEBUG] Failed to redeem code: " .. code .. " | Error: " .. tostring(err))
            end
            
            task.wait(0.20)  -- ä¿æŒåŽŸå»¶è¿Ÿ
        end
        
        -- æ–°å¢žè°ƒè¯•ï¼šæ‰“å°å…‘æ¢å®Œæˆ
        print("[DEBUG] Finished redeeming all codes.")
    end,
})

-------------------------------------------------
local CollectTab = Window:Tab({
        Title = "Collect",
        Icon = "gift",
    })

--Auto Collect Hourly and Daily Rewards
CollectTab:Toggle({
    Flag = "HourlyDailyRewards1",
    Title = "Auto Collect Hourly and Daily Rewards",
    Desc = "Automatically collect hourly and daily rewards",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().HourlyDailyRewardsRunning = true
            task.spawn(function()
                while getgenv().HourlyDailyRewardsRunning do
                    pcall(function()
                        -- âœ… è‡ªåŠ¨é¢†å–æ¯å°æ—¶å¥–åŠ±
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                            ["Value"] = true,
                            ["Path"] = {
                                [1] = "Settings",
                                [2] = "Auto_Hourly_Rewards",
                            },
                            ["Action"] = "Settings",
                        })

                        -- âœ… è‡ªåŠ¨é¢†å–æ¯æ—¥å¥–åŠ±
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                            ["Value"] = true,
                            ["Path"] = {
                                [1] = "Settings",
                                [2] = "Auto_Daily_Rewards",
                            },
                            ["Action"] = "Settings",
                        })
                    end)

                    -- æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆ300 ç§’ï¼‰
                    task.wait(5)
                end
            end)
        else
            getgenv().HourlyDailyRewardsRunning = false
        end
    end,
})

--Auto Claim Group Chest
CollectTab:Toggle({
    Flag = "ClaimGroupChest1",
    Title = "Auto Claim Group Chest",
    Desc = "Automatically claim group chest",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().ClaimGroupChestRunning = true
            task.spawn(function()
                while getgenv().ClaimGroupChestRunning do
                    pcall(function()
                        -- âœ… è‡ªåŠ¨å‡çº§å£°æœ›
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Action"] = "_Chest_Claim",
                        ["Name"] = "Group",
                        })
                    end)

                    task.wait(60)
                end
            end)
        else
            getgenv().ClaimGroupChestRunning = false
        end
    end,
})

--Auto Claim Premium Chest
CollectTab:Toggle({
    Flag = "ClaimPremiumChest1",
    Title = "Auto Claim Premium Chest",
    Desc = "Automatically claim premium chest",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().ClaimPremiumChestRunning = true
            task.spawn(function()
                while getgenv().ClaimPremiumChestRunning do
                    pcall(function()
                        -- âœ… è‡ªåŠ¨å‡çº§å£°æœ›
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Action"] = "_Chest_Claim",
                        ["Name"] = "Premium",
                        })
                    end)

                    task.wait(60)
                end
            end)
        else
            getgenv().ClaimPremiumChestRunning = false
        end
    end,
})

--Auto Claim VIP Chest
CollectTab:Toggle({
    Flag = "ClaimVIPChest1",
    Title = "Auto Claim VIP Chest",
    Desc = "Automatically claim VIP chest",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().ClaimVIPChestRunning = true
            task.spawn(function()
                while getgenv().ClaimVIPChestRunning do
                    pcall(function()
                        -- âœ… è‡ªåŠ¨å‡çº§å£°æœ›
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Action"] = "_Chest_Claim",
                        ["Name"] = "Vip",
                        })
                    end)

                    task.wait(60)
                end
            end)
        else
            getgenv().ClaimVIPChestRunning = false
        end
    end,
})

--Auto Claim Daily Chest
CollectTab:Toggle({
    Name = "Auto Claim Daily Chest",
    Title = "Auto Claim Daily Chest",
    Desc = "Automatically claim daily chest",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().ClaimDailyChestRunning = true
            task.spawn(function()
                while getgenv().ClaimDailyChestRunning do
                    pcall(function()
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Action"] = "_Chest_Claim",
                        ["Name"] = "Daily",
                        })
                    end)

                    task.wait(60)
                end
            end)
        else
            getgenv().ClaimDailyChestRunning = false
        end
    end,
})

local QuestTab = Window:Tab({
        Title = "Quests",
        Icon = "scroll-text",
    })

--Auto Get Daily Quest
QuestTab:Toggle({
    Flag = "DailyQuest1",
   Title = "Auto Get Daily Quest",
   Desc = "Automatically accept daily quests",
   Default = false,
   Callback = function(state)
   local dailyquests = {"2001","2002","2003","2004","2005","2006","2007"}
   if state then
    getgenv().AutoDailyQuestRunning = true
    task.spawn(function()
        while getgenv().AutoDailyQuestRunning do
            pcall(function()
                for _, dailyquest in ipairs(dailyquests) do
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = dailyquest,
                        ["Type"] = "Accept",
                        ["Action"] = "_Quest",
                    })
                    task.wait(0.3)
                   end
            end)
            task.wait(5)

        end
    end)
   else
    getgenv().AutoDailyQuestRunning = false
   end
end,
})

--Auto Find & Collect Punching Machine
QuestTab:Toggle({
    Flag = "Quest2301",
   Title = "Auto Get Punching Machine Quest & Collect",
   Desc = "Automatically accept and complete Punching Machine quest",
   Default = false,
   Callback = function(state)
   if state then
    getgenv().AutoPunchQuestRunning = true
    task.spawn(function()
        while getgenv().AutoPunchQuestRunning do
            pcall(function()
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2301",
                        ["Type"] = "Accept",
                        ["Action"] = "_Quest",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Type"] = "Find_Found",
                        ["Action"] = "_Quest",
                        ["Target"] = "Punching_Machine",
                        ["Object_Index"] = 1,
                        ["Id"] = "2301",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2301",
                        ["Type"] = "Complete",
                        ["Action"] = "_Quest",
                    })
            end)
            task.wait(60)

        end
    end)
   else
    getgenv().AutoPunchQuestRunning = false
   end
end,
})

--Auto Hero Quests

--Auto Demon Fruit Quest
QuestTab:Toggle({
    Flag = "Quest2302",
   Title = "Auto Get Demon Fruit Quest & Collect",
   Desc = "Automatically accept and complete Demon Fruit quest",
   Default = false,
   Callback = function(state)
   if state then
    getgenv().AutoDemonFruitQuestRunning = true
    task.spawn(function()
        while getgenv().AutoDemonFruitQuestRunning do
            pcall(function()
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2302",
                        ["Type"] = "Accept",
                        ["Action"] = "_Quest",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Type"] = "Find_Found",
                        ["Action"] = "_Quest",
                        ["Target"] = "Demon_Fruit",
                        ["Object_Index"] = 1,
                        ["Id"] = "2302",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2302",
                        ["Type"] = "Complete",
                        ["Action"] = "_Quest",
                    })
            end)
            task.wait(60)

        end
    end)
   else
    getgenv().AutoDemonFruitQuestRunning = false
   end
end,
})

--Auto Complete Briefcase Quest
QuestTab:Toggle({
    Flag = "Quest2601",
   Title = "Auto Get Briefcase Quest & Collect",
   Desc = "Automatically accept and complete Briefcase quest",
   Default = false,
   Callback = function(state)
   if state then
    getgenv().AutoBriefcaseQuestRunning = true
    task.spawn(function()
        while getgenv().AutoBriefcaseQuestRunning do
            pcall(function()
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2601",
                        ["Type"] = "Accept",
                        ["Action"] = "_Quest",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Type"] = "Find_Found",
                        ["Action"] = "_Quest",
                        ["Target"] = "_Briefcase",
                        ["Object_Index"] = 1,
                        ["Id"] = "2601",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2601",
                        ["Type"] = "Complete",
                        ["Action"] = "_Quest",
                    })
            end)
            task.wait(60)

        end
    end)
   else
    getgenv().AutoBriefcaseQuestRunning = false
   end
end,
})

--Auto Complete Assassin Knife Quest
QuestTab:Toggle({
    Flag = "Quest2609",
   Title = "Auto Get Assassin Knife Quest & Collect",
   Desc = "Automatically accept and complete Assassin Knife quest",
   Default = false,
   Callback = function(state)
   if state then
    getgenv().AutoAssassinKnifeQuestRunning = true
    task.spawn(function()
        while getgenv().AutoAssassinKnifeQuestRunning do
            pcall(function()
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2609",
                        ["Type"] = "Accept",
                        ["Action"] = "_Quest",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Type"] = "Find_Found",
                        ["Action"] = "_Quest",
                        ["Target"] = "Assassin_Knife",
                        ["Object_Index"] = 1,
                        ["Id"] = "2609",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2609",
                        ["Type"] = "Complete",
                        ["Action"] = "_Quest",
                    })
            end)
            task.wait(60)

        end
    end)
   else
    getgenv().AutoAssassinKnifeQuestRunning = false
   end
end,
})

--Auto Complete Assassin Pistol Quest
QuestTab:Toggle({
    Flag = "Quest2610",
   Title = "Auto Get Assassin Pistol Quest & Collect",
   Desc = "Automatically accept and complete Assassin Pistol quest",
   Default = false,
   Callback = function(state)
   if state then
    getgenv().AutoAssassinPistolQuestRunning = true
    task.spawn(function()
        while getgenv().AutoAssassinPistolQuestRunning do
            pcall(function()
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2610",
                        ["Type"] = "Accept",
                        ["Action"] = "_Quest",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Type"] = "Find_Found",
                        ["Action"] = "_Quest",
                        ["Target"] = "Assassin_Pistol",
                        ["Object_Index"] = 1,
                        ["Id"] = "2610",
                    })
                    task.wait(1.5)
                    game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                        ["Id"] = "2610",
                        ["Type"] = "Complete",
                        ["Action"] = "_Quest",
                    })
            end)
            task.wait(60)

        end
    end)
   else
    getgenv().AutoAssassinPistolQuestRunning = false
   end
end,
})


local StarTab = Window:Tab({
        Title = "Star",
        Icon = "star",
    })

--Auto Open Star
local StarDropdown = StarTab:Dropdown({
    Flag = "StarDropdown",
   Title = "Star List",
   Values = {"[W1] Earth City","[W2] Windmill Island","[W3] Soul Society","[W4] Cursed School","[W5] Slayer Village",

    "[W6] Solo Island","[W7] Clover Village","[W8] Leaf Village","[W9] Spirit Residence","[W10] Magic Hunter City",

    "[W11] Titan City","[W12] Village of Sins","[W13] Kaiju Base","[W14] Tempest Capital","[W15] Virtual City",

    "[W16] Cairo","[W17] Ghoul City","[W18] Chainsaw City","[W19] Tokyo Empire","[W20] Green Planet",

    "[W21] Hollow World","[W22] Shadow Academy","[W23] Z City","[W24] Great Tomb","[W25] Thriller Park",

    "[W26] Amusement Park","[W27] Re:Manor","[W28] Asfordo Academy","[W29] Science Village","[W30] Sand Village",

    "[W31] Night Raid Base"
},
    Value = "[W1] Earth City",
    Callback = function(option)
        getgenv().selectedStars = option
        print("[DEBUG] Star Option changed:", option)
    end,
})

-- Auto Open Star Toggle
StarTab:Toggle({
    Flag = "AutoOpenStar1",
    Title = "Auto Open Star",
    Desc = "Automatically Open Max Selected Star",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().AutoOpenStar = true
            task.spawn(function()
                while getgenv().AutoOpenStar do
                    pcall(function()
                        -- æå–æ•°å­—å¹¶æž„é€  Name ä¸º "Star_X" æ ¼å¼
                        local worldNumber = string.match(getgenv().selectedStars, "(%d+)")
                        if worldNumber then
                            game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                                ["Open_Amount"] = 30,
                                ["Name"] = "Star_" .. worldNumber,
                                ["Action"] = "_Stars",
                            })
                        end
                        task.wait(0.05)
                    end)
                end
            end)
        else
            getgenv().AutoOpenStar = false
            print("[DEBUG] AutoOpenStar disabled")
        end
    end,
})

local RollTab = Window:Tab({
        Title = "Roll",
        Icon = "dices",
    })

--Auto Open Star
local RollDropdown = RollTab:Dropdown({
    Flag = "RollDropdown",
   Title = "Roll List",
   Values = {"[W1] Dragon Race","[W1] Saiyan Evolution",
    "[W2] Pirate Crew","[W2] Demon Fruits","[W2] Swords",
    "[W3] Reiatsu Color","[W3] Zanpakuto",
    "[W4] Curses",
    "[W5] Demon Arts",
    "[W6] Solo Hunter Rank",
    "[W7] Grimoire",
    "[W8] Power Eyes",
    "[W9] Psychic Mayhem",
    "[W10] Energy Card Shop","[W10] Damage Card Shop",
    "[W11] Families","[W11] Titans",
    "[W12] Sins","[W12] Commandments",
    "[W13] Kaiju Powers","[W13] Power of Exchange",
    "[W14] Ultimate Skills","[W14] Species",
    "[W15] Power Energy Runes",
    "[W16] Stands","[W16] Onomatopoeia",
    "[W17] Investigators","[W17] Kagune",
    "[W18] Debiru Hunter","[W18] Akuma Powers",
    "[W19] Special Fire Force", "[W19] Mushi Bite",
    "[W20] Grand Elder Power", "[W20] Frost Demon Evolution", "[W20] Power of Friendship",
    "[W21] Scythes","[W21] Espada",
    "[W22] Shadow Garden","[W22] Shadow Arts",
    "[W23] Energy Threat Level","[W23] Punch Power","[W23] Exchange of Power",
    "[W24] Adventurer Rank","[W24] Magic Tier",
    "[W25] Thriller Zombie","[W25] Nightmare Evolution","[W25] Special Zombie",
    "[W26] Assassin Grade","[W26] Assassin Skills",
    "[W27] Spirit Pact","[W27] Witch Factor","[W27] Re:Spirit Pact","[W27] Re:Witch Factor","[W27] Witch Authority",
    "[W28] Geass Potential","[W28] Knightmare Frames",
    "[W29] IQ","[W29] Scientific Weapons",
    "[W30] Shinobi Clan","[W30] Kekkei Genkai","[W30] Power Eyes 2",
    "[W31] Energy Teigu","[W31] Damage Teigu"
},
    Value = "[W1] Dragon Race",
    Callback = function(option)
        getgenv().selectedRolls = option
        print("[DEBUG] Roll Option changed:", option)
    end,
})

-- Auto Roll Toggle
RollTab:Toggle({
    Flag = "AutoRoll1",
    Title = "Auto Roll",
    Desc = "Automatically Roll Max Selected Roll",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().AutoRoll = true
            print("[DEBUG] AutoRoll enabled")
            task.spawn(function()
                while getgenv().AutoRoll do
                    pcall(function()
                        print("[DEBUG] Attempting to roll, selectedRolls:", getgenv().selectedRolls)
                        -- ç”Ÿæˆ Nameï¼šç§»é™¤ "[W X] " å‰ç¼€ï¼Œå¹¶å°†ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
                        local name = string.gsub(getgenv().selectedRolls, "^%[W%d+%] ", ""):gsub(" ", "_")
                        print("[DEBUG] Generated name:", name)
                        game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                            ["Open_Amount"] = 5,
                            ["Name"] = name,
                            ["Action"] = "_Gacha_Activate",
                        })
                        task.wait(0.05)
                    end)
                end
            end)
        else
            getgenv().AutoRoll = false
            print("[DEBUG] AutoRoll disabled")
        end
    end,
})

local ProgressionTab = Window:Tab({
        Title = "Progression",
        Icon = "chevrons-up",
    })

--Auto Progression Upgrade
local ProgressionDropdown = ProgressionTab:Dropdown({
    Flag = "ProgressionDropdown",
   Title = "Progression List",
   Values = {"[W2] Haki Upgrade",
    "[W3] Spiritual Pressure",
    "[W4] Cursed Progression",
    "[W6] ReAwakening Progression","[W6] Monarch Progression",
    "[W7] Water Spirit Progression","[W7] Fire Spirit Progression","[W7] Wind Spirit Progression",
    "[W8] Chakra Progression",
    "[W9] Spiritual Upgrade","[W9] Lucky Spirit",
    "[W10] Ten Progression","[W10] Contract of Greed",
    "[W12] Sins Upgrades (Energy)","[W12] Sins Upgrades (Coins)","[W12] Sins Upgrades (Star_Luck)","[W12] Sins Upgrades (Damage)","[W12] Energy Progression",
    "[W13] Fortitude Level", "[W13] Kaiju Energy",
    "[W14] Demon Lord Energy", "[W14] Demon Lord Damage","[W14] Demon Lord Luck","[W14] Demon Lord Coins",
    "[W15] Swordsman Energy","[W15] Swordsman Damage",
    "[W16] Ripple Energy",
    "[W17] Damange Cells",
    "[W18] Akuma Damage","[W18] Akuma Energy",
    "[W20] Dragon Energy","[W20] Dragon Damage",
    "[W22] Eminence Energy","[W22] Eminence Damage","[W22] Eminence Luck","[W22] Eminence Coins",
    "[W23] Punch Power Leveling",
    "[W24] Mana Growth","[W24] Ultimate Cast",
    "[W26] Assassin Energy","[W26] Assassin Damage","[W26] Assassin Critical Energy","[W26] Assassin Critical Damage",
    "[W29] Science Materials Upgrade","[W29] Science Upgrades (Energy)","[W29] Science Upgrades (Damage)"
},
    Value = "[W2] Haki Upgrade",
    Callback = function(option)
        getgenv().selectedProgression = option
        print("[DEBUG] Progression Option changed:", option)
    end,
})

local ProgressionMap = {
    ["[W2] Haki Upgrade"] = {"Haki_Upgrade", "Haki_Upgrade", "_Upgrades"},
    ["[W3] Spiritual Pressure"] = {"Spiritual_Pressure", "Spiritual_Pressure", "_Upgrades"},
    ["[W4] Cursed Progression"] = {"Curse", "Cursed_Progression", "_Upgrades"},
    ["[W6] ReAwakening Progression"] = {"ReAwakening", "ReAwakening_Progression", "_Upgrades"},
    ["[W6] Monarch Progression"] = {"Monarch", "Monarch_Progression", "_Upgrades"},
    ["[W7] Water Spirit Progression"] = {"Water_Spirit", "Water_Spirit_Progression", "_Upgrades"},
    ["[W7] Fire Spirit Progression"] = {"Fire_Spirit", "Fire_Spirit_Progression", "_Upgrades"},
    ["[W7] Wind Spirit Progression"] = {"Wind_Spirit", "Wind_Spirit_Progression", "_Upgrades"},
    ["[W8] Chakra Progression"] = {"Chakra", "Chakra_Progression", "_Upgrades"},
    ["[W9] Spiritual Upgrade"] = {"Spiritual_Upgrade", "Spiritual_Upgrade", "_Upgrades"},
    ["[W9] Lucky Spirit"] = {"Luck", "Lucky_Spirit", "_Progression"},
    ["[W10] Ten Progression"] = {"Ten", "Ten_Progression", "_Upgrades"},
    ["[W10] Contract of Greed"] = {"Coins", "Contract_of_Greed", "_Progression"},
    ["[W12] Sins Upgrades (Energy)"] = {"Energy", "Sin_Upgrades", "_Upgrades"},
    ["[W12] Sins Upgrades (Coins)"] = {"Coins", "Sin_Upgrades", "_Upgrades"},
    ["[W12] Sins Upgrades (Star_Luck)"] = {"Star_Luck", "Sin_Upgrades", "_Upgrades"},
    ["[W12] Sins Upgrades (Damage)"] = {"Damage", "Sin_Upgrades", "_Upgrades"},
    ["[W12] Energy Progression"] = {"Strenght", "Energy_Progression", "_Progression"},
    ["[W13] Fortitude Level"] = {"Strenght", "Fortitude_Level", "_Progression"},
    ["[W13] Kaiju Energy"] = {"Energy", "Kaiju_Energy", "_Progression"},
    ["[W14] Demon Lord Energy"] = {"Energy", "Demon_Lord_Energy", "_Progression"},
    ["[W14] Demon Lord Damage"] = {"Damage", "Demon_Lord_Damage", "_Progression"},
    ["[W14] Demon Lord Luck"] = {"Luck", "Demon_Lord_Luck", "_Progression"},
    ["[W14] Demon Lord Coins"] = {"Coins", "Demon_Lord_Coins", "_Progression"},
    ["[W15] Swordsman Energy"] = {"Energy", "Swordsman_Energy", "_Progression"},
    ["[W15] Swordsman Damage"] = {"Damage", "Swordsman_Damage", "_Progression"},
    ["[W16] Ripple Energy"] = {"Energy", "Ripple_Energy", "_Progression"},
    ["[W17] Damange Cells"] = {"Damage", "Damage_Cells", "_Progression"},
    ["[W18] Akuma Damage"] = {"Damage", "Akuma_Damage", "_Progression"},
    ["[W18] Akuma Energy"] = {"Energy", "Akuma_Energy", "_Progression"},
    ["[W20] Dragon Energy"] = {"Energy", "Dragon_Energy", "_Progression"},
    ["[W20] Dragon Damage"] = {"Damage", "Dragon_Damage", "_Progression"},
    ["[W22] Eminence Energy"] = {"Energy", "Eminence_Energy", "_Progression"},
    ["[W22] Eminence Damage"] = {"Damage", "Eminence_Damage", "_Progression"},
    ["[W22] Eminence Luck"] = {"Luck", "Eminence_Luck", "_Progression"},
    ["[W22] Eminence Coins"] = {"Coins", "Eminence_Coins", "_Progression"},
    ["[W23] Punch Power Leveling"] = {"Damage", "Hide_n_Punch_Progression", "_Progression"},
    ["[W24] Mana Growth"] = {"Energy", "Mana_Growth", "_Progression"},
    ["[W24] Ultimate Cast"] = {"Damage", "Ultimate_Cast", "_Progression"},
    ["[W26] Assassin Energy"] = {"Energy", "Assassin_Energy", "_Progression"},
    ["[W26] Assassin Damage"] = {"Damage", "Assassin_Damage", "_Progression"},
    ["[W26] Assassin Critical Energy"] = {"Critical_Energy", "Assassin_Critical_Energy", "_Progression"},
    ["[W26] Assassin Critical Damage"] = {"Critical_Damage", "Assassin_Critical_Damage", "_Progression"},
    ["[W29] Science Materials Upgrade"] = {"Science_Materials", "Science_Materials_Upgrade", "_Progression"},
    ["[W29] Science Upgrades (Energy)"] = {"Energy", "Science_Upgrades", "_Upgrades"},
    ["[W29] Science Upgrades (Damage)"] = {"Damage", "Science_Upgrades", "_Upgrades"},
}

-- Auto Progression Toggle
ProgressionTab:Toggle({
    Flag = "AutoProgression1",
    Title = "Auto Progression",
    Desc = "Automatically Upgrade Selected Progression",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().AutoProgression = true
            print("[DEBUG] AutoProgression enabled")
            task.spawn(function()
                while getgenv().AutoProgression do
                    pcall(function()
                        print("[DEBUG] Attempting to upgrade, selectedProgression:", getgenv().selectedProgression)
                        local progressionData = ProgressionMap[getgenv().selectedProgression]
                        if progressionData then
                            local upgradingName, upgradeName, action = progressionData[1], progressionData[2], progressionData[3]
                            print("[DEBUG] Upgrading_Name:", upgradingName, "Upgrade_Name:", upgradeName, "Action:", action)
                            if action == "_Progression" then
                                game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                                    ["Upgrade_Name"] = upgradingName,
                                    ["Action"] = "_Progression",
                                    ["Bench_Name"] = upgradeName,
                                })
                            else
                                game:GetService("ReplicatedStorage").Events.To_Server:FireServer({
                                    ["Upgrading_Name"] = upgradingName,
                                    ["Action"] = "_Upgrades",
                                    ["Upgrade_Name"] = upgradeName,
                                })
                            end
                        else
                            print("[DEBUG] No mapping found for:", getgenv().selectedProgression)
                        end
                        task.wait(0.05)
                    end)
                end
            end)
        else
            getgenv().AutoProgression = false
            print("[DEBUG] AutoProgression disabled")
        end
    end,
})

-------------------------------------------------
--ðŸŒ¾ Farm Tab
-------------------------------------------------
local mobNames = {}
local mobMap = {}
local selectedMobs = {}
local player = game.Players.LocalPlayer
local rootPart = player.Character:WaitForChild("HumanoidRootPart")

-- å…¨å±€æŽ§åˆ¶å˜é‡
getgenv().AutoFarmRunning = false
getgenv().FarmTargetChanged = false
getgenv().InDungeon = false
getgenv().InRaid = false
getgenv().AutoDungeonFarmRunning = false
getgenv().WasAutoFarmRunning = false

--Farm Tab
local FarmTab = Window:Tab({
        Title = "Farm",
        Icon = "sprout",
    })

-- âœ… Mob åˆ—è¡¨ Dropdown
local MobDropdown = FarmTab:Dropdown({
    Flag = "Dropdown1",
    Title = "Mobs List",
    Values = {"None"},
    Value = {"None"},
    Multi = true,
    AllowNone = true,
    Callback = function(option)
        selectedMobs = option or {}
        getgenv().FarmTargetChanged = true
        print("[DEBUG] ðŸŽ¯ Mob target changed:", table.concat(selectedMobs, ", "))
    end,
})

-- âœ… åˆ·æ–°æŒ‰é’®
local MobRefreshButton = FarmTab:Button({
    Flag = "RefreshButton1",
    Title = "Refresh Mobs List",
    Callback = function()
        mobNames, mobMap, selectedMobs = {}, {}, {}
        local monstersFolder = workspace:FindFirstChild("Debris") and workspace.Debris:FindFirstChild("Monsters")

        if not monstersFolder then
            MobDropdown:Refresh({"None"})
            return
        end

        for _, mob in pairs(monstersFolder:GetChildren()) do
            if mob and mob:IsA("Model") then
                local mobsname = mob:GetAttribute("Title") or mob.Name
                local mobsrank = mob:GetAttribute("Rank")
                local mobsdisplayname = mobsrank and mobsrank ~= "" and string.format("[%s] %s", mobsrank, mobsname) or mobsname
                if not mobMap[mobsdisplayname] then
                    mobMap[mobsdisplayname] = {}
                    table.insert(mobNames, mobsdisplayname)
                end
                table.insert(mobMap[mobsdisplayname], mob)
            end
        end

        if #mobNames == 0 then
            MobDropdown:Refresh({"None"})
        else
            MobDropdown:Refresh(mobNames)
        end
    end,
})

-- âœ… æ™®é€š Auto Farm é€»è¾‘
local AutoFarmToggle = FarmTab:Toggle({
    Flag = "AutoFarm1",
    Title = "Auto Farm",
    Default = false,
    Callback = function(state)
        if state then
            getgenv().AutoFarmRunning = true
            getgenv().FarmTargetChanged = true
            getgenv().WasAutoFarmRunning = true
                
            task.spawn(function()
                while getgenv().AutoFarmRunning and not getgenv().InDungeon do
                    if getgenv().FarmTargetChanged then
                        getgenv().FarmTargetChanged = false
                    end

                    local char = player.Character
                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                    if not hrp then task.wait(1) continue end

                    local monstersFolder = workspace:FindFirstChild("Debris") and workspace.Debris:FindFirstChild("Monsters")
                    if monstersFolder then
                        mobMap = {}
                        for _, mob in pairs(monstersFolder:GetChildren()) do
                            if mob and mob:IsA("Model") then
                                local mobsname = mob:GetAttribute("Title") or mob.Name
                                local mobsrank = mob:GetAttribute("Rank")
                                local mobsdisplayname = mobsrank and mobsrank ~= "" and string.format("[%s] %s", mobsrank, mobsname) or mobsname
                                if not mobMap[mobsdisplayname] then
                                    mobMap[mobsdisplayname] = {}
                                end
                                table.insert(mobMap[mobsdisplayname], mob)
                            end
                        end
                    end

                    for _, mobName in ipairs(selectedMobs) do
                        if not getgenv().AutoFarmRunning or getgenv().FarmTargetChanged or getgenv().InDungeon then break end
                        local mobList = mobMap[mobName]
                        if mobList then
                            for _, mob in ipairs(mobList) do
                                if not getgenv().AutoFarmRunning or getgenv().FarmTargetChanged or getgenv().InDungeon then break end
                                local mobHRP = mob:FindFirstChild("HumanoidRootPart")
                                if mobHRP then
                                    hrp.CFrame = mobHRP.CFrame + Vector3.new(0, 0, 2)
                                    repeat task.wait(0.05) until not mob.Parent or not getgenv().AutoFarmRunning or getgenv().FarmTargetChanged or getgenv().InDungeon
                                end
                            end
                        end
                    end
                    task.wait(0.05)
                end
            end)
        else
            getgenv().AutoFarmRunning = false
            getgenv().FarmTargetChanged = true
            getgenv().WasAutoFarmRunning = false
        end
    end,
})

-------------------------------------------------
-- CONSTANTS / TABLES
-------------------------------------------------

-- Dungeon é€‰é¡¹
local DungeonOptions = {
    "Dungeon Easy","Dungeon Medium","Dungeon Hard","Dungeon Insane",
    "Dungeon Crazy","Dungeon Nightmare","Leaf Raid"
}

-- Raid / KeyDungeon / Defense é€‰é¡¹
local RaidOptions = {
    "Restaurant Raid","Cursed Raid","Progression Raid","Titan Defense",
    "Sin Raid","Kaiju Dungeon","Dragon Room Raid","Gleam Raid","Progression Raid 2",
    "Ghoul Raid","Chainsaw Defense","Netherworld Defense","Green Planet Raid",
    "Hollow Raid","Tomb Arena Raid","Halloween Raid","Graveyard Raid",
    "Dungeon Suffering","Dungeon Adventure","Dungeon Torment","Maze Level 1","Maze Level 2","Maze Level 3","Dungeon Labyrinth","Crimson Canyon"
}

local SpeedRaids = {
    ["Cursed Raid"] = true,
    ["Progression Raid"] = true,
    ["Progression Raid 2"] = true,
    ["Restaurant Raid"] = true,
    ["Dungeon Labyrinth"] = true,
    ["Maze Level 1"] = true,
    ["Maze Level 2"] = true,
    ["Maze Level 3"] = true
}

local RaidSpeedOptions = {"1x Speed", "2x Speed", "3x Speed"}

-- éœ€è¦ Auto Farm çš„ Dungeon å’Œ Mazeï¼ˆæ¥è‡ª DungeonOptions å’Œ RaidOptionsï¼‰
local AutoFarmDungeons = {
    "Dungeon Easy", "Dungeon Medium", "Dungeon Hard", "Dungeon Insane", "Dungeon Crazy", "Dungeon Nightmare",
    "Kaiju Dungeon", "Dungeon Suffering", "Dungeon Adventure", "Dungeon Torment", "Maze Level 1", "Maze Level 2", "Maze Level 3", "Dungeon Labyrinth",
    "Crimson Canyon"
}

-- Dungeon åç§°æ˜ å°„åˆ°ä¿¡å·ä¸­çš„ Nameï¼ˆä¾‹å¦‚ Dungeon Easy -> Dungeon_Easyï¼‰
local DungeonNameMap = {
    ["Dungeon Easy"] = "Dungeon_Easy",
    ["Dungeon Medium"] = "Dungeon_Medium",
    ["Dungeon Hard"] = "Dungeon_Hard",
    ["Dungeon Insane"] = "Dungeon_Insane",
    ["Dungeon Crazy"] = "Dungeon_Crazy",
    ["Dungeon Nightmare"] = "Dungeon_Nightmare",
}

-- Raid åç§°æ˜ å°„åˆ°ä¿¡å·ä¸­çš„ Nameï¼ˆä¾‹å¦‚ Kaiju Dungeon -> Kaiju_Dungeonï¼‰
local RaidNameMap = {
    ["Restaurant Raid"] = "Restaurant_Raid",
    ["Cursed Raid"] = "Cursed_Raid",
    ["Progression Raid"] = "Progression_Raid",
    ["Titan Defense"] = "Titan_Defense",
    ["Sin Raid"] = "Sin_Raid",
    ["Kaiju Dungeon"] = "Kaiju_Dungeon",
    ["Dragon Room Raid"] = "Dragon_Room_Raid",
    ["Gleam Raid"] = "Gleam_Raid",
    ["Progression Raid 2"] = "Progression_Raid_2",
    ["Ghoul Raid"] = "Ghoul_Raid",
    ["Chainsaw Defense"] = "Chainsaw_Defense",
    ["Netherworld Defense"] = "Netherworld_Defense",
    ["Green Planet Raid"] = "Green_Planet_Raid",
    ["Hollow Raid"] = "Hollow_Raid",
    ["Tomb Arena Raid"] = "Tomb_Arena_Raid",
    ["Halloween Raid"] = "Halloween_Raid",
    ["Graveyard Raid"] = "Graveyard_Raid",
    ["Dungeon Suffering"] = "Dungeon_Suffering",
    ["Dungeon Adventure"] = "Dungeon_Adventure",
    ["Dungeon Torment"] = "Dungeon_Torment",
    ["Maze Level 1"] = "Maze_Level_1",
    ["Maze Level 2"] = "Maze_Level_2",
    ["Maze Level 3"] = "Maze_Level_3",
    ["Dungeon Labyrinth"] = "Dungeon_Labyrinth",
    ["Crimson Canyon"] = "Crimson_Canyon"
}

-------------------------------------------------
-- GLOBAL VARIABLES
-------------------------------------------------
-- Dungeon Auto Farm
getgenv().SelectedDungeons = {}
getgenv().AutoDungeonEnabled = false
getgenv().InDungeon = false
getgenv().AutoDungeonFarmRunning = false
getgenv().CurrentDungeonName = nil

-- Raid / KeyDungeon Auto Farm
getgenv().SelectedRaids = {}
getgenv().SelectedRaidSpeed = "1x Speed"
getgenv().AutoRaidEnabled = false
getgenv().InRaid = false
getgenv().AutoRaidFarmRunning = false
getgenv().IsCurrentKeyDungeon = false
getgenv().CurrentRaidIndex = 1  -- ç”¨äºŽå¾ªçŽ¯ Raid
getgenv().CurrentRaidName = nil

-- æ™®é€š AutoFarm æš‚åœæ¢å¤æŽ§åˆ¶
getgenv().AutoFarmRunning = false
getgenv().WasAutoFarmRunning = false
getgenv().FarmTargetChanged = false

-- å…¶ä»–å˜é‡
local player = game:GetService("Players").LocalPlayer
local Remote = game:GetService("ReplicatedStorage").Events.To_Client
local ToServer = game:GetService("ReplicatedStorage").Events.To_Server

-------------------------------------------------
-- FUNCTIONS
-------------------------------------------------

-- æ£€æŸ¥æ˜¯å¦æ˜¯éœ€è¦ Auto Farm çš„ Dungeon
local function IsAutoFarmDungeon(dungeonName)
    for _, name in ipairs(AutoFarmDungeons) do
        if name == dungeonName then
            return true
        end
    end
    return false
end

-- å¯åŠ¨ Dungeon Auto Farm
local function StartDungeonAutoFarm()
    if getgenv().AutoDungeonFarmRunning then return end
    getgenv().AutoDungeonFarmRunning = true
    print("[DEBUG] AutoDungeonFarm started")
    task.wait(1)  -- è¿›å…¥raidåŽç­‰å¾…1ç§’
    task.spawn(function()
        while getgenv().AutoDungeonFarmRunning and getgenv().InDungeon do
            print("[DEBUG] Loop running, InDungeon:", getgenv().InDungeon)
            local char = player.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            if not hrp then print("[DEBUG] No HumanoidRootPart, waiting") task.wait(0.2) continue end

            local monstersFolder = workspace:FindFirstChild("Debris") and workspace.Debris:FindFirstChild("Monsters")
            local hasMonsters = monstersFolder and #monstersFolder:GetChildren() > 0
            print("[DEBUG] Monsters folder exists:", monstersFolder ~= nil, "Has monsters:", hasMonsters, "Count:", monstersFolder and #monstersFolder:GetChildren() or 0)

            -- å¦‚æžœraidä¸­æœ‰æ€ªç‰©ï¼Œå…ˆæ¸…æŽ‰
            if hasMonsters then
                print("[DEBUG] Monsters present, farming them")
                if monstersFolder then
                    for _, mob in pairs(monstersFolder:GetChildren()) do
                        if not getgenv().AutoDungeonFarmRunning or not getgenv().InDungeon then break end
                        if mob:IsA("Model") and mob:GetAttribute("Is_Dungeon") == true then
                            local mobHRP = mob:FindFirstChild("HumanoidRootPart")
                            if mobHRP then
                                print("[DEBUG] Farming mob:", mob.Name)
                                hrp.CFrame = mobHRP.CFrame + Vector3.new(0, 0, 2)
                                repeat task.wait(0.05) until not mob.Parent or not getgenv().AutoDungeonFarmRunning or not getgenv().InDungeon
                            end
                        end
                    end
                end
            else
                -- å¦‚æžœæ²¡æœ‰æ€ªç‰©ï¼Œæ£€æµ‹Doorå¹¶æŒ‰ä¼˜å…ˆçº§å¼€ï¼ˆMonster_Roomä¿å­˜å¹¶å¼€ -> Treasure_Room -> Merchant_Room -> End_Roomï¼‰
                print("[DEBUG] No monsters, checking for doors")
                pcall(function()
                    local openedDoor = false
                    -- å¾ªçŽ¯workspace.Dungeonsçš„æ‰€æœ‰raid
                    for _, dungeon in pairs(workspace.Dungeons:GetChildren()) do
                        print("[DEBUG] Checking dungeon:", dungeon.Name, "Is Folder:", dungeon:IsA("Folder"))
                        if dungeon:IsA("Folder") and (dungeon.Name:find("Dungeon_Labyrinth") or dungeon.Name:find("Maze_Level_1") or dungeon.Name:find("Maze_Level_2") or dungeon.Name:find("Maze_Level_3")) then
                            print("[DEBUG] Dungeon matches, collecting doors")
                            -- ä¿å­˜Doorä½ç½®ï¼ŒæŒ‰ç±»åž‹åˆ†ç»„ï¼ˆraidç»“æŸåŽlocalå˜é‡æ¸…é™¤ï¼‰
                            local Monster_Room_Doors = {}
                            local Treasure_Room_Doors = {}
                            local Merchant_Room_Doors = {}
                            local End_Room_Doors = {}
                            for _, room in pairs(dungeon:GetChildren()) do
                                print("[DEBUG] Room:", room.Name, "Is Model:", room:IsA("Model"))
                                if room:IsA("Model") and room:FindFirstChild("Doors") then
                                    local doorsFolder = room:FindFirstChild("Doors")
                                    for _, door in pairs(doorsFolder:GetChildren()) do
                                        print("[DEBUG] Door in folder:", door.Name, "Is Model:", door:IsA("Model"))
                                        if door.Name == "ModelX" then
                                            local doorPart = door:FindFirstChild("Door")
                                            print("[DEBUG] Door part exists:", doorPart ~= nil, "Is BasePart:", doorPart and doorPart:IsA("BasePart"))
                                            if doorPart and doorPart:IsA("BasePart") then
                                                local hasWall = false
                                                for _, child in pairs(door:GetChildren()) do
                                                    if child.ClassName == "Part" and child.Name == "Wall" then
                                                        hasWall = true
                                                        break
                                                    end
                                                end
                                                print("[DEBUG] Has Wall:", hasWall)
                                                if not hasWall then
                                                    if room.Name:find("^Monsters_Room_") then
                                                        table.insert(Monster_Room_Doors, doorPart)
                                                    elseif room.Name:find("^Treasure_Room_") then
                                                        table.insert(Treasure_Room_Doors, doorPart)
                                                    elseif room.Name:find("^Merchant_Room_") then
                                                        table.insert(Merchant_Room_Doors, doorPart)
                                                    elseif room.Name:find("^End_Room_") then
                                                        table.insert(End_Room_Doors, doorPart)
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                            print("[DEBUG] Monster_Room_Doors count:", #Monster_Room_Doors)
                            print("[DEBUG] Treasure_Room_Doors count:", #Treasure_Room_Doors)
                            print("[DEBUG] Merchant_Room_Doors count:", #Merchant_Room_Doors)
                            print("[DEBUG] End_Room_Doors count:", #End_Room_Doors)
                            -- å…ˆå¼€Monster_Roomçš„Doorï¼ˆä¿å­˜çš„ï¼‰ï¼Œå¼€ä¸€ä¸ªåŽç§»é™¤
                            for i = #Monster_Room_Doors, 1, -1 do
                                local doorPart = Monster_Room_Doors[i]
                                if doorPart and doorPart:IsA("BasePart") then
                                    print("[DEBUG] Opening Monster_Room door")
                                    -- ä¼ é€è¿‡åŽ»Doorçš„CFrameä½ç½®ï¼ˆæ›´è¿‘-5ç¡®ä¿Interactï¼‰
                                    local teleportPos = doorPart.Position + (doorPart.CFrame.LookVector * -5)
                                    print("[DEBUG] Teleporting to door position:", teleportPos)
                                    hrp.CFrame = CFrame.new(teleportPos)
                                    -- è®¾ç½®è§’è‰²é¢å‘é—¨
                                    hrp.CFrame = CFrame.lookAt(hrp.Position, doorPart.Position)
                                    -- ä¼ é€åŽcaptureä½ç½®å¹¶è°ƒæ•´ç›¸æœºé¢å‘é—¨
                                    local capturedPosition = hrp.Position
                                    local cam = workspace.CurrentCamera
                                    repeat cam.CameraType = Enum.CameraType.Scriptable until cam.CameraType == Enum.CameraType.Scriptable
                                    cam.CFrame = CFrame.lookAt(capturedPosition, doorPart.Position)
                                    task.delay(1/60, function()
	                                cam.CameraType = Enum.CameraType.Custom
                                    end)
                                    task.wait(0.35)  -- ç­‰å¾…ä¼ é€å’Œè§†è§’è°ƒæ•´
                                    game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.E, false, game)
                                    task.wait(0.35)
                                    game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.E, false, game)
                                    task.wait(0.2)  -- ç­‰å¾…å¼€é—¨åŽç»§ç»­
                                    openedDoor = true
                                    print("[DEBUG] Monster_Room Door opened")
                                    -- å¼€é—¨åŽç§»é™¤è¿™ä¸ªDoor
                                    table.remove(Monster_Room_Doors, i)
                                    -- å¼€é—¨åŽæ¸…æ€ªç‰©
                                    local monstersFolder = workspace:FindFirstChild("Debris") and workspace.Debris:FindFirstChild("Monsters")
                                    local hasMonsters = monstersFolder and #monstersFolder:GetChildren() > 0
                                    if hasMonsters then
                                        print("[DEBUG] Monsters present after opening door, farming them")
                                        if monstersFolder then
                                            for _, mob in pairs(monstersFolder:GetChildren()) do
                                                if not getgenv().AutoDungeonFarmRunning or not getgenv().InDungeon then break end
                                                if mob:IsA("Model") and mob:GetAttribute("Is_Dungeon") == true then
                                                    local mobHRP = mob:FindFirstChild("HumanoidRootPart")
                                                    if mobHRP then
                                                        print("[DEBUG] Farming mob:", mob.Name)
                                                        hrp.CFrame = mobHRP.CFrame + Vector3.new(0, 0, 2)
                                                        repeat task.wait(0.05) until not mob.Parent or not getgenv().AutoDungeonFarmRunning or not getgenv().InDungeon
                                                    end
                                                end
                                            end
                                        end
                                    end
                                    break  -- å¼€ä¸€ä¸ªMonster_Room DooråŽåœæ­¢
                                end
                            end
                            -- ç„¶åŽå¼€ä¿å­˜çš„Doorï¼šTreasure -> Merchant -> End
                            local doorGroups = {Treasure_Room_Doors, Merchant_Room_Doors, End_Room_Doors}
                            for groupIndex, doorGroup in ipairs(doorGroups) do
                                for _, doorPart in ipairs(doorGroup) do
                                    print("[DEBUG] Opening door in group:", groupIndex)
                                    -- ä¼ é€è¿‡åŽ»Doorçš„CFrameä½ç½®ï¼ˆæ›´è¿‘-5ç¡®ä¿Interactï¼‰
                                    local teleportPos = doorPart.Position + (doorPart.CFrame.LookVector * -5)
                                    print("[DEBUG] Teleporting to door position:", teleportPos)
                                    hrp.CFrame = CFrame.new(teleportPos)
                                    -- è®¾ç½®è§’è‰²é¢å‘é—¨
                                    hrp.CFrame = CFrame.lookAt(hrp.Position, doorPart.Position)
                                    -- ä¼ é€åŽcaptureä½ç½®å¹¶è°ƒæ•´ç›¸æœºé¢å‘é—¨
                                    local capturedPosition = hrp.Position
                                    local cam = workspace.CurrentCamera
                                    repeat cam.CameraType = Enum.CameraType.Scriptable until cam.CameraType == Enum.CameraType.Scriptable
                                    cam.CFrame = CFrame.lookAt(capturedPosition, doorPart.Position)
                                    task.delay(1/60, function()
	                                cam.CameraType = Enum.CameraType.Custom
                                    end)
                                    task.wait(0.35)  -- ç­‰å¾…ä¼ é€å’Œè§†è§’è°ƒæ•´
                                    game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.E, false, game)
                                    task.wait(0.35)
                                    game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.E, false, game)
                                    task.wait(0.2)  -- ç­‰å¾…å¼€é—¨åŽç»§ç»­
                                    openedDoor = true
                                    print("[DEBUG] Door opened")
                                    -- å¼€é—¨åŽæ¸…æ€ªç‰©
                                    local monstersFolder = workspace:FindFirstChild("Debris") and workspace.Debris:FindFirstChild("Monsters")
                                    local hasMonsters = monstersFolder and #monstersFolder:GetChildren() > 0
                                    if hasMonsters then
                                        print("[DEBUG] Monsters present after opening door, farming them")
                                        if monstersFolder then
                                            for _, mob in pairs(monstersFolder:GetChildren()) do
                                                if not getgenv().AutoDungeonFarmRunning or not getgenv().InDungeon then break end
                                                if mob:IsA("Model") and mob:GetAttribute("Is_Dungeon") == true then
                                                    local mobHRP = mob:FindFirstChild("HumanoidRootPart")
                                                    if mobHRP then
                                                        print("[DEBUG] Farming mob:", mob.Name)
                                                        hrp.CFrame = mobHRP.CFrame + Vector3.new(0, 0, 2)
                                                        repeat task.wait(0.05) until not mob.Parent or not getgenv().AutoDungeonFarmRunning or not getgenv().InDungeon
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                            end
                            if openedDoor then break end  -- å¦‚æžœå¼€äº†é—¨ï¼Œåœæ­¢æ£€æŸ¥å…¶ä»–raid
                        end
                    end
                end)
            end
            task.wait(0.5)
        end
    end)
end

-- åœæ­¢ Dungeon Auto Farm
local function StopDungeonAutoFarm()
    getgenv().AutoDungeonFarmRunning = false
    print("[DEBUG] AutoDungeonFarm stopped - Door positions cleared (local variables)")
end

-- å¯åŠ¨æ™®é€š Auto Farm
local function StartNormalAutoFarm()
    if getgenv().AutoFarmRunning then return end
    getgenv().AutoFarmRunning = true
    getgenv().FarmTargetChanged = true
    getgenv().WasAutoFarmRunning = true
    task.spawn(function()
        while getgenv().AutoFarmRunning and not getgenv().InDungeon do
            if getgenv().FarmTargetChanged then
                getgenv().FarmTargetChanged = false
            end

            local char = player.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            if not hrp then task.wait(1) continue end

            local monstersFolder = workspace:FindFirstChild("Debris") and workspace.Debris:FindFirstChild("Monsters")
            if monstersFolder then
                mobMap = {}
                for _, mob in pairs(monstersFolder:GetChildren()) do
                    if mob and mob:IsA("Model") then
                        local mobsname = mob:GetAttribute("Title") or mob.Name
                        local mobsrank = mob:GetAttribute("Rank")
                        local mobsdisplayname = mobsrank and mobsrank ~= "" and string.format("[%s] %s", mobsrank, mobsname) or mobsname
                        if not mobMap[mobsdisplayname] then
                            mobMap[mobsdisplayname] = {}
                        end
                        table.insert(mobMap[mobsdisplayname], mob)
                    end
                end
            end

            for _, mobName in ipairs(selectedMobs) do
                if not getgenv().AutoFarmRunning or getgenv().FarmTargetChanged or getgenv().InDungeon then break end
                local mobList = mobMap[mobName]
                if mobList then
                    for _, mob in ipairs(mobList) do
                        if not getgenv().AutoFarmRunning or getgenv().FarmTargetChanged or getgenv().InDungeon then break end
                        local mobHRP = mob:FindFirstChild("HumanoidRootPart")
                        if mobHRP then
                            hrp.CFrame = mobHRP.CFrame + Vector3.new(0, 0, 2)
                            repeat task.wait(0.05) until not mob.Parent or not getgenv().AutoFarmRunning or getgenv().FarmTargetChanged or getgenv().InDungeon
                        end
                    end
                end
            end
            task.wait(0.05)
        end
    end)
end

-- åœæ­¢æ™®é€š Auto Farm
local function StopNormalAutoFarm()
    if getgenv().AutoFarmRunning then
        getgenv().AutoFarmRunning = false
        getgenv().WasAutoFarmRunning = true
        getgenv().FarmTargetChanged = true
        print("[DEBUG] Stopped Normal Auto Farm")
    end
end

-- è¿›å…¥ Raid
local function EnterRaid(raidName)
    local name = RaidNameMap[raidName]
    if not name then return end

    local data = { ["Action"] = "_Enter_Dungeon", ["Name"] = name }

    if SpeedRaids[raidName] then
        data["Is_New"] = true
        if getgenv().SelectedRaidSpeed == "2x Speed" then
            data["Name"] = name .. "_x2"
        elseif getgenv().SelectedRaidSpeed == "3x Speed" then
            data["Name"] = name .. "_x3"
        end
    end

    getgenv().CurrentRaidName = raidName
    ToServer:FireServer(data)
    print("[DEBUG] Entering Raid:", raidName, "with data:", data)
end

-- å¾ªçŽ¯è¿›å…¥ä¸‹ä¸€ä¸ª Raid
local function EnterNextRaid()
    if #getgenv().SelectedRaids == 0 then return end
    local raidName = getgenv().SelectedRaids[getgenv().CurrentRaidIndex]
    EnterRaid(raidName)
    getgenv().CurrentRaidIndex = getgenv().CurrentRaidIndex % #getgenv().SelectedRaids + 1
end

-- æ¢å¤æ™®é€š Auto Farm
local function ResumeAutoFarm()
    task.delay(5, function()
        if not getgenv().InDungeon and not getgenv().InRaid and getgenv().WasAutoFarmRunning then
            StartNormalAutoFarm()
            print("[DEBUG] Resuming Auto Farm after 5 seconds")
        end
    end)
end

-------------------------------------------------
-- LISTENERS
-------------------------------------------------

-- ç›‘å¬ Dungeon Opened ä¿¡å·ï¼ˆç”¨äºŽè‡ªåŠ¨è¿›å…¥ Dungeonï¼‰
Remote.OnClientEvent:Connect(function(data)
    if data.Action == "System_Message" and data.Text and data.Text.Type == "Dungeon_Message" then
        local text = data.Text.Text
        for dungeonName, signalName in pairs(DungeonNameMap) do
            if string.find(text, dungeonName) and getgenv().AutoDungeonEnabled and table.find(getgenv().SelectedDungeons, dungeonName) then
                StopNormalAutoFarm()  -- åœ¨è¿›å…¥ Dungeon ä¹‹å‰åœæ­¢æ™®é€š Auto Farm
                -- å‘é€è¿›å…¥ Dungeon çš„ä¿¡å·
                ToServer:FireServer({
                    ["Action"] = "_Enter_Dungeon",
                    ["Name"] = signalName,
                })
                getgenv().CurrentDungeonName = dungeonName
                print("[DEBUG] Auto Entering Dungeon:", dungeonName, "with Name:", signalName)
                break  -- å‡è®¾ä¸€æ¬¡åªåŒ¹é…ä¸€ä¸ª
            end
        end
    elseif data.Action == "Dungeon" and data.Type == "Outlines" then
        if data.Players then
            -- è¿›å…¥ Dungeon/Raid
            getgenv().InDungeon = true
            getgenv().InRaid = false  -- é»˜è®¤ Dungeon
            local currentName = getgenv().CurrentDungeonName or getgenv().CurrentRaidName
            if currentName and IsAutoFarmDungeon(currentName) then
                StartDungeonAutoFarm()
            end
            if getgenv().CurrentRaidName then
                getgenv().InRaid = true
                StopNormalAutoFarm()  -- è¿›å…¥ Raid åŽåœæ­¢æ™®é€š Auto Farm
            end
            print("[DEBUG] Entered Dungeon/Raid")
        else
            -- ç¦»å¼€ Dungeon/Raid
            getgenv().InDungeon = false
            getgenv().InRaid = false
            StopDungeonAutoFarm()
            getgenv().CurrentDungeonName = nil
            getgenv().CurrentRaidName = nil
            ResumeAutoFarm()  -- æ€»æ˜¯å°è¯•æ¢å¤æ™®é€š Auto Farm
            if getgenv().AutoRaidEnabled then
                EnterNextRaid()
            end
            print("[DEBUG] Left Dungeon/Raid")
        end
    end
end)

-- å¾ªçŽ¯ Raid è¿›å…¥ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
task.spawn(function()
    while true do
        if getgenv().AutoRaidEnabled and not getgenv().InRaid and #getgenv().SelectedRaids > 0 then
            EnterNextRaid()
        end
        task.wait(1)  -- æ£€æŸ¥é—´éš”
    end
end)

-------------------------------------------------
-- UI: Dungeon Tab
-------------------------------------------------
local AutoDungeonTab = Window:Tab({
        Title = "Dungeon",
        Icon = "castle",
    })

local AutoDungeonDropdown = AutoDungeonTab:Dropdown({
    Flag = "DungeonSelect1",
    Title = "Select Dungeons",
    Values = DungeonOptions,
    Value = {"None"},
    Multi = true,
    AllowNone = true,
    Callback = function(option)
        getgenv().SelectedDungeons = option
        print("[DEBUG] ðŸ° Selected Dungeons:", table.concat(option, ", "))
    end,
})

local AutoDungeonToggle = AutoDungeonTab:Toggle({
    Flag = "AutoJoinDungeon1",
    Title = "Auto Join Dungeon + Auto Farm",
    Default = false,
    Callback = function(state)
        getgenv().AutoDungeonEnabled = state
        print(state and "[DEBUG] ðŸŸ¢ Auto Dungeon Enabled" or "[DEBUG] ðŸ”´ Auto Dungeon Disabled")
    end,
})

-------------------------------------------------
-- UI: Raid / KeyDungeon / Defense Tab
-------------------------------------------------
local AutoRaidTab = Window:Tab({
        Title = "Raid",
        Icon = "skull",
    })

local AutoRaidDropdown = AutoRaidTab:Dropdown({
    Flag = "RaidSelect1",
    Title = "Select Raid",
    Values = RaidOptions,
    Value = {},
    Multi = true,
    Callback = function(option)
        getgenv().SelectedRaids = option
        getgenv().CurrentRaidIndex = 1
        print("[DEBUG] â˜ ï¸ Selected Raids:", table.concat(option, ", "))
    end,
})

local AutoRaidSpeedDropdown = AutoRaidTab:Dropdown({
    Flag = "RaidSpeedSelect1",
    Title = "Raid Speed",
    Values = RaidSpeedOptions,
    Value = "1x Speed",
    Multi = false,
    Callback = function(option)
        getgenv().SelectedRaidSpeed = option
        print("[DEBUG] â˜ ï¸ Raid Speed Selected:", option)
    end,
})

local AutoRaidToggle = AutoRaidTab:Toggle({
    Flag = "AutoJoinRaid1",
    Title = "Auto Join Raid + Auto Farm",
    Default = false,
    Callback = function(state)
        getgenv().AutoRaidEnabled = state
        print(state and "[DEBUG] ðŸŸ¢ Auto Raid Enabled" or "[DEBUG] ðŸ”´ Auto Raid Disabled")
    end,
})
